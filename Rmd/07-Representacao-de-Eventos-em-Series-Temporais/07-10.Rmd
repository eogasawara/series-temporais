---
title: "Aula 07 - Slide 10"
output: html_document
---

## Objetivo
Reproduzir a figura/resultado do slide 10 da Aula 07.

## Descricao
Este documento explica o passo a passo do codigo para gerar a figura/resultado associado ao slide.

## Conexao com o PDF
Slide 10 do PDF correspondente da Aula 07.

## Referencia
Hyndman, R.J., Athanasopoulos, G. (2021). Forecasting: Principles and Practice (3rd ed.). OTexts.

```{r codigo, message=FALSE, warning=FALSE}
# Didatico: roteiro em 3 passos
# 1) Carregar dependencias/rotinas auxiliares.
# 2) Preparar dados e parametros do exemplo.
# 3) Gerar a figura/resultado esperado.
# Aula 07 — Slide 10
# Evento como Ruptura Estrutural (mudança de regime) — marcação de change point
# Gera: slides/07-10.png

source("slides/utils.R")

if (!requireNamespace("forecast", quietly = TRUE)) install.packages("forecast")
if (!requireNamespace("ggplot2", quietly = TRUE)) install.packages("ggplot2")

library(forecast)
library(ggplot2)

set.seed(7)

# Simular dois regimes com parâmetros diferentes (θ1 != θ2)
n <- 300
cp <- 170

x1 <- as.numeric(arima.sim(model=list(ar=0.6), n=cp, sd=0.6)) + 0.0
x2 <- as.numeric(arima.sim(model=list(ar=0.2), n=n-cp, sd=1.1)) + 1.8
x_ts <- ts(c(x1, x2))

out_png <- har_slide_file("07", "10")

# Preferir Harbinger para "event/change point"
ok <- FALSE
try({
  har_save_plot(
    file = out_png,
    obj = NULL,
    serie = x_ts,
    idx = cp,
    detection = "manual",
    event = "change-point",
    mark.cp = TRUE
  )
  ok <- TRUE
}, silent = TRUE)

# Fallback: ggplot/autoplot com linha vertical
if (!ok) {
  df <- data.frame(t=1:length(x_ts), x=as.numeric(x_ts))
  p <- autoplot(x_ts) +
    ggtitle("Ruptura estrutural: dois regimes (θ1 ≠ θ2)") +
    geom_vline(xintercept = cp, linetype = 2) +
    annotate("text", x=cp, y=max(df$x), label="τ (ruptura)", hjust=0, vjust=-0.5, size=3)
  har_ggsave_px(out_png, p)
}

message("PNG gerado em: ", out_png)
```

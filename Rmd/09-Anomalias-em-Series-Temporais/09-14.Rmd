---
title: "Aula 09 - Slide 14"
output: html_document
---

## Objetivo
Reproduzir a figura/resultado do slide 14 da Aula 09.

## Descricao
Este documento explica o passo a passo do codigo para gerar a figura/resultado associado ao slide.

## Conexao com o PDF
Slide 14 do PDF correspondente da Aula 09.

## Referencia
Hyndman, R.J., Athanasopoulos, G. (2021). Forecasting: Principles and Practice (3rd ed.). OTexts.

```{r codigo, message=FALSE, warning=FALSE}
# Didatico: roteiro em 3 passos
# 1) Carregar dependencias/rotinas auxiliares.
# 2) Preparar dados e parametros do exemplo.
# 3) Gerar a figura/resultado esperado.
source("slides/utils.R")

# Aula 09 — Slide 14: Anomalias e Componentes Temporais
# (a) Anomalia no valor (pico pontual)
# (b) Anomalia na tendência (mudança local de inclinação, depois volta)
# (c) Anomalia na volatilidade (explosão local de variância)
# Referência no PDF: Slide 14 ("Anomalias e Componentes Temporais")

suppressPackageStartupMessages({
  library(ggplot2)
})

set.seed(914)

n <- 300
t <- 1:n

# Base: tendência suave + sazonalidade + ruído
base_trend <- 0.01 * t
season <- 1.5 * sin(2*pi*t/30)
eps <- rnorm(n, sd=0.7)
x0 <- base_trend + season + eps

# (a) valor: pico pontual
xa <- x0
idx_val <- 120
xa[idx_val] <- xa[idx_val] + 6

# (b) tendência: mudança local de inclinação e retorno
xb <- x0
w <- 50
i1 <- 140
i2 <- i1 + w - 1
xb[i1:i2] <- xb[i1:i2] + seq(0, 4, length.out=w)

# (c) volatilidade: explosão local de variância
xc <- x0
j1 <- 200
j2 <- 240
xc[j1:j2] <- xc[j1:j2] + rnorm(j2-j1+1, sd=3)

plot_component <- function(x, title) {
  df <- data.frame(t=t, x=x)
  ggplot(df, aes(x=t, y=x)) + geom_line() + labs(x="t", y="x_t", title=title)
}

p_a <- plot_component(xa, "(a) Anomalia no valor: x_t")
p_b <- plot_component(xb, "(b) Anomalia na tendência: tr(x_t)")
p_c <- plot_component(xc, "(c) Anomalia na volatilidade: v(x_t)")

file_a <- har_slide_file(9, 14, "a")
file_b <- har_slide_file(9, 14, "b")
file_c <- har_slide_file(9, 14, "c")

har_ggsave_px(file_a, p_a, height_px = TSED_HEIGHT)
har_ggsave_px(file_b, p_b, height_px = TSED_HEIGHT)
har_ggsave_px(file_c, p_c, height_px = TSED_HEIGHT)

har_concat_png(har_slide_file(9, 14), c(file_a, file_b, file_c))
```

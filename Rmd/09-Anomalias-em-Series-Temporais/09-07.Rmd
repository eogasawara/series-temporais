---
title: "Aula 09 - Slide 07"
output: html_document
---

## Objetivo
Reproduzir a figura/resultado do slide 07 da Aula 09.

## Descricao
Este documento explica o passo a passo do codigo para gerar a figura/resultado associado ao slide.

## Conexao com o PDF
Slide 07 do PDF correspondente da Aula 09.

## Referencia
Hyndman, R.J., Athanasopoulos, G. (2021). Forecasting: Principles and Practice (3rd ed.). OTexts.

```{r codigo, message=FALSE, warning=FALSE}
# Didatico: roteiro em 3 passos
# 1) Carregar dependencias/rotinas auxiliares.
# 2) Preparar dados e parametros do exemplo.
# 3) Gerar a figura/resultado esperado.
source("slides/utils.R")

# Aula 09 — Slide 07: Anomalias Estatísticas (limiar vs raridade)
# (a) Resíduos padronizados e limiar |r_t| > λσ_r
# (b) Mesma ideia como raridade: p-valor empírico no |R_t|
# Referência no PDF: Slide 07 ("Anomalias Estatísticas")

suppressPackageStartupMessages({
  library(forecast)
  library(ggplot2)
})

set.seed(907)

# Série sintética: AR(1) + 2 outliers
n <- 260
x <- as.numeric(arima.sim(model=list(ar=0.75), n=n))
idx0 <- c(90, 200)
x[idx0] <- x[idx0] + c(7, -6)
serie <- ts(x)

# Ajuste ARIMA (baseline) para obter resíduos
fit0 <- forecast::Arima(serie, order=c(1,0,0))
res  <- as.numeric(residuals(fit0))
sr   <- sd(res, na.rm=TRUE)

# Critério por limiar
lambda <- 3
tau <- lambda * sr
idx_thr <- which(abs(res) > tau)

df <- data.frame(t=1:length(res), res=res)

p_a <- ggplot(df, aes(x=t, y=res)) +
  geom_line() +
  geom_hline(yintercept = c(-tau, tau), linetype="dashed") +
  geom_point(data=df[idx_thr, , drop=FALSE], aes(x=t, y=res), size=2) +
  labs(
    x="t", y="r_t",
    title="(a) Critério por limiar: |r_t| > λ·σ_r"
  )

file_a <- har_slide_file(9, 7, "a")
har_ggsave_px(file_a, p_a, height_px = TSED_HEIGHT)

# Critério por raridade (p-valor empírico em |R_t|)
absres <- abs(res)
pval <- vapply(absres, function(u) mean(absres > u, na.rm=TRUE), numeric(1))

df2 <- data.frame(t=1:length(res), pval=pval)

alpha <- 0.01
idx_p <- which(pval < alpha)

p_b <- ggplot(df2, aes(x=t, y=pval)) +
  geom_line() +
  geom_hline(yintercept = alpha, linetype="dashed") +
  geom_point(data=df2[idx_p, , drop=FALSE], aes(x=t, y=pval), size=2) +
  labs(
    x="t", y="p-valor empírico",
    title="(b) Critério por raridade: P(|R| > |r_t|) < α"
  )

file_b <- har_slide_file(9, 7, "b")
har_ggsave_px(file_b, p_b, height_px = TSED_HEIGHT)

har_concat_png(har_slide_file(9, 7), c(file_a, file_b))
```
